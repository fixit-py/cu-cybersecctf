FROM ubuntu:latest
WORKDIR /app

# Install socat for networking
RUN apt-get update && apt-get install -y socat && rm -rf /var/lib/apt/lists/*

# Create a non-root user
RUN useradd -r -s /bin/false -M ctfuser

# Copy files
COPY ./deepsea ./deepsea
COPY ./flag.txt ./flag.txt
COPY ./research ./research

# Set proper ownership and permissions
RUN chmod +x ./deepsea && \
    chmod 444 ./flag.txt && \
    chmod -R 555 ./research && \
    chown -R ctfuser:ctfuser /app

# Remove potentially dangerous binaries
RUN rm -f /bin/su /usr/bin/sudo /bin/mount /bin/umount /usr/bin/wget /usr/bin/curl \
    /usr/bin/nc /usr/bin/netcat /bin/ping /usr/bin/ssh /usr/bin/scp

# Switch to non-root user
USER ctfuser

EXPOSE 1337

# Use socat to listen on port 1337 and execute our binary for each connection
CMD ["socat", "TCP-LISTEN:1337,fork,reuseaddr", "EXEC:./deepsea"]
