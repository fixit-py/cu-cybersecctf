#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

void print_banner() {
    printf("     ~~~~~~~~~~~~~~~~~\n");
    printf("   ~~~   DEEP SEA   ~~~\n");
    printf(" ~~~ RESEARCH STATION ~~~\n");
    printf("   ~~~ CONTROL v2.1 ~~~    \n");
    printf("     ~~~~~~~~~~~~~~~~~\n");
    printf("      |    |    |\n");
    printf("      |    |    |\n");
    printf("   ___/____/____\\___\n");
    printf("  [   AUTHORIZED   ]\n");
    printf("  [ PERSONNEL ONLY ]\n");
    printf("   \\_______________/\n");
    printf("        ||||||\n");
    printf("      ~~~~~~~~~~\n\n");
}

void show_help() {
    printf("DEEPSEA> Available commands:\n");
    printf("1. status - Check station status\n");
    printf("2. probe [section] - Probe research section contents\n");
    printf("3. help - Show this help message\n");
    printf("4. exit - Terminate connection\n\n");
    printf("Available research sections:\n");
    printf("- biology    - Marine biology data\n");
    printf("- geology    - Seafloor geological surveys\n");
    printf("- sensors    - Environmental sensor data\n");
    printf("- specimens  - Research specimen logs\n");
    printf("- equipment  - Equipment maintenance logs\n");
}

void show_status() {
    printf("[STATION STATUS]\n");
    printf("Depth: 2,847 meters\n");
    printf("Pressure: 284.7 bar\n");
    printf("Temperature: 4.2Â°C\n");
    printf("Oxygen levels: 98.7%%\n");
    printf("Hull integrity: NOMINAL\n");
    printf("Last surface contact: 2025-09-11 14:22:00\n");
}

void probe_section(char* section) {
    char command[512];
    char path[256];
    
    // Create the path
    snprintf(path, sizeof(path), "./research/%s", section);
    
    printf("[PROBING]: %s\n", section);
    
    // Basic input filtering - block common command injection attempts and tell them what we blocked
    char *blocked_commands[] = {
        "cat", "head", "tail", "more", "less", "grep", "awk", "cut", "sort", "uniq", "tr", "wc",
        "find", "locate", "which", "whereis", "file", "strings", "hexdump", "xxd", "od", "base64",
        "python", "perl", "php", "ruby", "node", "sh", "bash", "zsh", "dash", "csh", "tcsh", "ksh", "fish",
        "nc", "netcat", "wget", "curl", "ftp", "ssh", "scp", "rsync", "cp", "mv", "rm", "mkdir", "rmdir",
        "touch", "chmod", "chown", "chgrp", "ln", "dd", "tar", "zip", "unzip", "gzip", "gunzip",
        "bzip2", "bunzip2", "xz", "unxz", "7z", "rar", "unrar", "ps", "top", "htop", "kill", "killall",
        "pkill", "nohup", "jobs", "bg", "fg", "disown", "screen", "tmux", "sudo", "su", "passwd",
        "useradd", "userdel", "usermod", "groupadd", "groupdel", "id", "whoami", "who", "w", "last",
        "lastlog", "history", "env", "export", "set", "unset", "alias", "unalias", "type", "command",
        "builtin", "enable", "disable", "exec", "eval", "source", "read", "echo", "printf", "test",
        "expr", "bc", "dc", "calc", "vim", "vi", "nano", "emacs", "pico", "joe", "mc", "man", "info",
        "help", "apropos", "whatis"
    };
    
    int num_blocked = sizeof(blocked_commands) / sizeof(blocked_commands[0]);
    
    for (int i = 0; i < num_blocked; i++) {
        if (strstr(section, blocked_commands[i]) != NULL) {
            printf("SECURITY ALERT: Command '%s' is blocked by security filters\n", blocked_commands[i]);
            printf("Attempted command injection detected and prevented\n");
            return;
        }
    }
    
    sprintf(command, "ls -l %s 2>/dev/null", path);
    system(command);
}

int main() {
    char input[256];
    
    // Disable output buffering
    setvbuf(stdout, NULL, _IONBF, 0);
    setvbuf(stderr, NULL, _IONBF, 0);
    
    print_banner();
    show_help();
    
    while (1) {
        printf("DEEPSEA> ");
        
        if (!fgets(input, sizeof(input), stdin)) {
            break;
        }
        
        // Remove newline
        input[strcspn(input, "\n")] = 0;
        
        if (strcmp(input, "exit") == 0) {
            printf("Terminating deep sea connection...\n");
            break;
        }
        else if (strcmp(input, "help") == 0) {
            show_help();
        }
        else if (strcmp(input, "status") == 0) {
            show_status();
        }
        else if (strcmp(input, "probe") == 0) {
            printf("ERROR: No section specified.\n");
            printf("Usage: probe [section]\n");
            printf("Available sections: biology, geology, sensors, specimens, equipment\n");
        }
        else if (strncmp(input, "probe ", 6) == 0) {
            // Extract everything after "probe "
            char *section = input + 6;
            probe_section(section);
        }
        else {
            printf("ERROR: Unknown command. Type 'help' for available commands.\n");
        }
        
        printf("\n");
    }
    
    return 0;
}
